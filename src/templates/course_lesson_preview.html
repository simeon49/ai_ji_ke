{% extends "base.html" %}
{% from "_course_base.html" import shared_styles, sidebar, shared_scripts %}

{% block title %}{{ file_name }} - AIæå®¢{% endblock %}

{% block extra_head %}
{{ shared_styles() }}
<script src="/static/marked.min.js"></script>
{% endblock %}

{% block content %}
{{ sidebar(chapters, None, course_name, course_path) }}

<div class="page-layout" id="mainLayout">
    <main class="main-content">
        <div class="breadcrumb-bar">
            <a href="/courses">è¯¾ç¨‹åˆ—è¡¨</a> / <a href="/courses/org_courses/{{ course_path }}" class="course-name">{{ course_name }}</a> / {{ file_name }}
        </div>
        <div class="rich-content" id="rendered-content"></div>
        <pre id="raw-content" style="display:none;">{{ content }}</pre>
    </main>
    
    <!-- æµ®åŠ¨éŸ³é¢‘æŒ‰é’® -->
    <button class="audio-fab" id="audioFab" title="éŸ³é¢‘æ’­æ”¾">ğŸµ</button>
    
    <!-- é®ç½©å±‚ -->
    <div class="audio-player-overlay" id="audioOverlay"></div>
    
    <!-- éŸ³é¢‘æ’­æ”¾å¼¹çª— -->
    <aside class="audio-player-bar" id="audioPlayerBar">
        <div class="audio-player-header">
            <div class="audio-player-title">éŸ³é¢‘æ’­æ”¾</div>
            <button class="audio-player-close" id="audioCloseBtn" title="å…³é—­">âœ•</button>
        </div>
        <div class="audio-player-controls">
            <div class="audio-player-main-controls">
                <button class="audio-player-btn" id="rewindBtn" title="åé€€10ç§’">âª</button>
                <button class="audio-player-btn play-pause" id="playPauseBtn" title="æ’­æ”¾/æš‚åœ">â–¶</button>
                <button class="audio-player-btn" id="forwardBtn" title="å¿«è¿›10ç§’">â©</button>
            </div>
            <div class="audio-player-progress">
                <input type="range" class="audio-player-progress-bar" id="progressBar" min="0" max="100" value="0">
                <div class="audio-player-time">
                    <span id="currentTime">00:00</span>
                    <span id="duration">00:00</span>
                </div>
            </div>
            <div class="audio-player-speed">
                <span class="audio-player-speed-label">å€é€Ÿ:</span>
                <select class="audio-player-speed-select" id="speedSelect">
                    <option value="0.5">0.5x</option>
                    <option value="0.75">0.75x</option>
                    <option value="1" selected>1x</option>
                    <option value="1.25">1.25x</option>
                    <option value="1.5">1.5x</option>
                    <option value="2">2x</option>
                </select>
            </div>
        </div>
    </aside>
    
    <audio id="audioElement" style="display:none;"></audio>
</div>
{% endblock %}

{% block extra_scripts %}
{{ shared_scripts() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // è‡ªåŠ¨å±•å¼€åŒ…å«å½“å‰è¯¾ç¨‹çš„ç« èŠ‚
    const activeLesson = document.querySelector('.lesson-item.active');
    if (activeLesson) {
        const lessonList = activeLesson.closest('.lesson-list');
        if (lessonList) {
            lessonList.classList.remove('collapsed');
            const chapterHeader = lessonList.previousElementSibling;
            if (chapterHeader) {
                const toggle = chapterHeader.querySelector('.chapter-toggle');
                if (toggle) {
                    toggle.classList.remove('collapsed');
                }
            }
        }
    }

    // æ¸²æŸ“ Markdown
    const rawContent = document.getElementById('raw-content').textContent;
    const renderedContent = document.getElementById('rendered-content');

    marked.setOptions({
        breaks: true,
        gfm: true,
        highlight: function(code, lang) {
            return code;
        }
    });

    renderedContent.innerHTML = marked.parse(rawContent);

    // å¤„ç†å›¾ç‰‡å’Œåª’ä½“
    const coursePath = '{{ course_path }}';
    processImages(renderedContent, coursePath);
    processMediaLinks(renderedContent, coursePath);

    // åˆå§‹åŒ–éŸ³é¢‘æ’­æ”¾æ 
    initAudioPlayer();

    // åˆå§‹åŒ–å­¦ä¹ è¿›åº¦è¿½è¸ª
    initLearningProgress();
});

// éŸ³é¢‘æ’­æ”¾æ åˆå§‹åŒ–
function initAudioPlayer() {
    const audioPlayerBar = document.getElementById('audioPlayerBar');
    const audioElement = document.getElementById('audioElement');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const progressBar = document.getElementById('progressBar');
    const currentTimeEl = document.getElementById('currentTime');
    const durationEl = document.getElementById('duration');
    const speedSelect = document.getElementById('speedSelect');
    const rewindBtn = document.getElementById('rewindBtn');
    const forwardBtn = document.getElementById('forwardBtn');
    const audioFab = document.getElementById('audioFab');
    const audioOverlay = document.getElementById('audioOverlay');
    const audioCloseBtn = document.getElementById('audioCloseBtn');
    
    const renderedContent = document.getElementById('rendered-content');
    const audioInContent = renderedContent.querySelector('audio');
    
    if (!audioInContent) {
        return;
    }
    
    audioElement.src = audioInContent.src;
    
    const audioParent = audioInContent.parentElement;
    if (audioParent && audioParent.textContent.includes('éŸ³é¢‘')) {
        audioParent.style.display = 'none';
    } else {
        audioInContent.style.display = 'none';
    }
    
    const isWideScreen = window.innerWidth > 1024;
    
    if (isWideScreen) {
        audioPlayerBar.classList.add('visible');
    } else {
        audioFab.classList.add('has-audio');
    }
    
    function openPlayer() {
        audioPlayerBar.classList.add('visible');
        audioOverlay.classList.add('visible');
    }
    
    function closePlayer() {
        if (!isWideScreen) {
            audioPlayerBar.classList.remove('visible');
            audioOverlay.classList.remove('visible');
        }
    }
    
    audioFab.addEventListener('click', openPlayer);
    audioCloseBtn.addEventListener('click', closePlayer);
    audioOverlay.addEventListener('click', closePlayer);
    
    playPauseBtn.addEventListener('click', function() {
        if (audioElement.paused) {
            audioElement.play();
            playPauseBtn.textContent = 'â¸';
            audioFab.classList.add('playing');
        } else {
            audioElement.pause();
            playPauseBtn.textContent = 'â–¶';
            audioFab.classList.remove('playing');
        }
    });
    
    forwardBtn.addEventListener('click', function() {
        audioElement.currentTime = Math.min(audioElement.currentTime + 10, audioElement.duration);
    });
    
    rewindBtn.addEventListener('click', function() {
        audioElement.currentTime = Math.max(audioElement.currentTime - 10, 0);
    });
    
    audioElement.addEventListener('timeupdate', function() {
        const progress = (audioElement.currentTime / audioElement.duration) * 100;
        progressBar.value = progress;
        currentTimeEl.textContent = formatTime(audioElement.currentTime);
    });
    
    progressBar.addEventListener('input', function() {
        const time = (progressBar.value / 100) * audioElement.duration;
        audioElement.currentTime = time;
    });
    
    audioElement.addEventListener('loadedmetadata', function() {
        durationEl.textContent = formatTime(audioElement.duration);
    });
    
    speedSelect.addEventListener('change', function() {
        audioElement.playbackRate = parseFloat(this.value);
    });
    
    audioElement.addEventListener('ended', function() {
        playPauseBtn.textContent = 'â–¶';
        audioFab.classList.remove('playing');
    });
    
    audioElement.addEventListener('error', function() {
        console.error('éŸ³é¢‘åŠ è½½å¤±è´¥:', audioElement.src);
        audioPlayerBar.style.display = 'none';
        audioFab.style.display = 'none';
    });
    
    window.addEventListener('resize', function() {
        const nowWide = window.innerWidth > 1024;
        if (nowWide && !audioPlayerBar.classList.contains('visible')) {
            audioPlayerBar.classList.add('visible');
            audioOverlay.classList.remove('visible');
            audioFab.classList.remove('has-audio');
        } else if (!nowWide && !audioOverlay.classList.contains('visible')) {
            audioPlayerBar.classList.remove('visible');
            audioFab.classList.add('has-audio');
        }
    });
}

// æ ¼å¼åŒ–æ—¶é—´ (ç§’ -> MM:SS)
function formatTime(seconds) {
    if (isNaN(seconds)) {
        return '00:00';
    }
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
}

// å­¦ä¹ è¿›åº¦è¿½è¸ª
function initLearningProgress() {
    const renderedContent = document.getElementById('rendered-content');
    const currentLessonPath = window.location.pathname.replace('/course_lesson_preview/', '');
    const coursePath = '{{ course_path }}';

    // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆ
    checkLessonCompletion();

    // 1. æ»šåŠ¨æ£€æµ‹ - æ£€æµ‹æ˜¯å¦æ»šåŠ¨åˆ° "## ç²¾é€‰ç•™è¨€" æˆ–é¡µé¢åº•éƒ¨
    let scrollMarked = false;
    const scrollThreshold = 0.95; // 95% æ»šåŠ¨

    function checkScrollProgress() {
        if (scrollMarked) return;

        const scrollTop = window.scrollY;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const scrollPercent = scrollTop / docHeight;

        // æ£€æŸ¥ "## ç²¾é€‰ç•™è¨€" æ ‡é¢˜æ˜¯å¦å‡ºç°åœ¨è§†å£å†…ï¼ˆå¯è§åŒºåŸŸï¼‰
        const commentSection = Array.from(renderedContent.querySelectorAll('h1, h2, h3')).find(el => {
            return el.textContent.includes('ç²¾é€‰ç•™è¨€');
        });

        if (commentSection) {
            const rect = commentSection.getBoundingClientRect();
            const windowHeight = window.innerHeight;

            // å¦‚æœ"ç²¾é€‰ç•™è¨€"å‡ºç°åœ¨é¡µé¢åº•éƒ¨åŒºåŸŸï¼ˆè§†å£åº•éƒ¨ 20% èŒƒå›´å†…ï¼‰
            if (rect.top > 0 && rect.top < windowHeight * 0.8) {
                markLessonCompleted('scroll');
                scrollMarked = true;
                return;
            }
        }

        // æ£€æŸ¥æ˜¯å¦æ»šåŠ¨åˆ°é¡µé¢åº•éƒ¨ 95%
        if (scrollPercent >= scrollThreshold) {
            markLessonCompleted('bottom');
            scrollMarked = true;
        }
    }

    window.addEventListener('scroll', checkScrollProgress);

    // 2. éŸ³é¢‘/è§†é¢‘æ’­æ”¾è¿›åº¦æ£€æµ‹
    const audioElement = document.getElementById('audioElement');
    const videoElement = renderedContent.querySelector('video');
    let mediaMarked = false;
    const mediaThreshold = 0.95; // 95% æ’­æ”¾

    function checkMediaProgress() {
        if (mediaMarked) return;

        if (audioElement && !audioElement.paused && audioElement.duration > 0) {
            const progress = audioElement.currentTime / audioElement.duration;
            if (progress >= mediaThreshold) {
                markLessonCompleted('media');
                mediaMarked = true;
            }
        }

        if (videoElement && !videoElement.paused && videoElement.duration > 0) {
            const progress = videoElement.currentTime / videoElement.duration;
            if (progress >= mediaThreshold) {
                markLessonCompleted('media');
                mediaMarked = true;
            }
        }
    }

    if (audioElement) {
        audioElement.addEventListener('timeupdate', checkMediaProgress);
    }
    if (videoElement) {
        videoElement.addEventListener('timeupdate', checkMediaProgress);
    }
}

// æ£€æŸ¥å°èŠ‚æ˜¯å¦å·²å®Œæˆ
async function checkLessonCompletion() {
    const currentLessonPath = window.location.pathname.replace('/course_lesson_preview/', '');
    const coursePath = '{{ course_path }}';
    const apiCoursePath = coursePath.startsWith('org_courses/') ? coursePath : 'org_courses/' + coursePath;

    try {
        const response = await fetch('/api/courses/' + apiCoursePath + '/learning-progress');
        if (response.ok) {
            const data = await response.json();
            if (data.completed_lessons && data.completed_lessons.includes(currentLessonPath)) {
                markLessonAsCompletedInUI();
            }
        }
    } catch (error) {
        console.error('Failed to check lesson completion:', error);
    }
}

// æ ‡è®°å°èŠ‚ä¸ºå·²å®Œæˆï¼ˆè°ƒç”¨ APIï¼‰
async function markLessonCompleted(completionType) {
    const currentLessonPath = window.location.pathname.replace('/course_lesson_preview/', '');
    const coursePath = '{{ course_path }}';
    const apiCoursePath = coursePath.startsWith('org_courses/') ? coursePath : 'org_courses/' + coursePath;

    // æ ‡å‡†åŒ– lesson_pathï¼šç§»é™¤ org_courses/ å‰ç¼€
    const normalizedLessonPath = currentLessonPath.startsWith('org_courses/') ? currentLessonPath.replace('org_courses/', '') : currentLessonPath;

    try {
        const response = await fetch('/api/courses/' + apiCoursePath + '/learning-progress', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                lesson_path: normalizedLessonPath,
                completion_type: completionType
            })
        });

        if (response.ok) {
            markLessonAsCompletedInUI();
            // åˆ·æ–°ä¾§è¾¹æ ä¸­æ‰€æœ‰å°èŠ‚çš„å­¦ä¹ è¿›åº¦
            refreshSidebarProgress();
        }
    } catch (error) {
        console.error('Failed to mark lesson as completed:', error);
    }
}

// åœ¨ UI ä¸­æ ‡è®°å°èŠ‚ä¸ºå·²å®Œæˆ
function markLessonAsCompletedInUI() {
    // æ ‡è®°ä¾§è¾¹æ ä¸­çš„å½“å‰å°èŠ‚
    const activeLesson = document.querySelector('.lesson-item.active');
    if (activeLesson) {
        activeLesson.classList.add('completed');
    }
}

// é‡æ–°åŠ è½½ä¾§è¾¹æ çš„å­¦ä¹ è¿›åº¦
async function refreshSidebarProgress() {
    const coursePath = '{{ course_path }}';
    const apiCoursePath = coursePath.startsWith('org_courses/') ? coursePath : 'org_courses/' + coursePath;

    try {
        const response = await fetch('/api/courses/' + apiCoursePath + '/learning-progress');
        if (response.ok) {
            const data = await response.json();
            if (data.completed_lessons) {
                updateAllSidebarLessons(data.completed_lessons);
            }
        }
    } catch (error) {
        console.error('Failed to refresh sidebar progress:', error);
    }
}

// æ›´æ–°ä¾§è¾¹æ ä¸­æ‰€æœ‰å°èŠ‚çš„å®ŒæˆçŠ¶æ€
function updateAllSidebarLessons(completedLessons) {
    console.log('updateAllSidebarLessons called with:', completedLessons);
    const lessonItems = document.querySelectorAll('.lesson-item');
    console.log('Found lesson items:', lessonItems.length);

    lessonItems.forEach(item => {
        const href = item.getAttribute('href');
        if (href) {
            let lessonPath = href.replace('/course_lesson_preview/', '');
            // æ ‡å‡†åŒ–ï¼šç§»é™¤ org_courses/ å‰ç¼€
            lessonPath = lessonPath.startsWith('org_courses/') ? lessonPath.replace('org_courses/', '') : lessonPath;

            const isCompleted = completedLessons.includes(lessonPath);
            console.log(`Lesson: ${lessonPath}, Completed: ${isCompleted}`);

            if (isCompleted) {
                item.classList.add('completed');
            }
        }
    });
}
</script>
{% endblock %}
