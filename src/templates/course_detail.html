{% extends "base.html" %}
{% from "_course_base.html" import shared_styles, sidebar, shared_scripts %}

{% block title %}{{ course_name }} - AIæå®¢{% endblock %}

{% block extra_head %}
{{ shared_styles() }}
<style>
    .intro-section {
        padding: 0;
        margin-bottom: 1.5rem;
    }
    .intro-section h3 {
        margin-bottom: 1.25rem;
        color: #1a1a2e;
        font-size: 1.25rem;
        font-weight: 600;
    }
    .course-meta-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        background: #f5f0e8;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        font-size: 0.85rem;
    }
    .course-id-label {
        color: #5d4e37;
        font-weight: 500;
    }
    .course-id-value {
        color: #8b7355;
        font-weight: 600;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }
</style>
<script src="/static/marked.min.js"></script>
{% endblock %}

{% block content %}
{{ sidebar(chapters, None, course_name, course_path) }}

<div class="page-layout" id="mainLayout">
    <main class="main-content">
        <div class="breadcrumb-bar">
            <a href="/courses">è¯¾ç¨‹åˆ—è¡¨</a> / <span class="course-name">{{ course_name }}</span>
        </div>

        <div class="course-meta-info">
            <span class="course-id-label">è¯¾ç¨‹ID:</span>
            <span class="course-id-value">{{ course_id }}</span>
        </div>

        {% if intro_content %}
        <div class="intro-section">
            <h3>è¯¾ç¨‹ä»‹ç»</h3>
            <div class="rich-content" id="introContent"></div>
        </div>
        {% endif %}

        {% if not intro_content and not chapters %}
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ“„</div>
            <p>è¯¥è¯¾ç¨‹æš‚æ— å†…å®¹</p>
        </div>
        {% endif %}
    </main>
</div>
{% endblock %}

{% block extra_scripts %}
{{ shared_scripts() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // åŠ è½½å­¦ä¹ è¿›åº¦
    loadLearningProgress();

    {% if intro_content %}
    const introMarkdown = {{ intro_content | tojson }};
    const introContent = document.getElementById('introContent');

    marked.setOptions({
        breaks: true,
        gfm: true,
        highlight: function(code, lang) {
            return code;
        }
    });

    introContent.innerHTML = marked.parse(introMarkdown);

    // å¤„ç†å›¾ç‰‡
    const coursePath = '{{ course_path }}';
    processImages(introContent, coursePath);
    {% endif %}
});

// åŠ è½½å­¦ä¹ è¿›åº¦å¹¶æ›´æ–°ä¾§è¾¹æ 
async function loadLearningProgress() {
    const coursePath = '{{ course_path }}';
    const apiCoursePath = coursePath.startsWith('org_courses/') ? coursePath : 'org_courses/' + coursePath;

    try {
        const response = await fetch('/api/courses/' + apiCoursePath + '/learning-progress');
        if (response.ok) {
            const data = await response.json();
            if (data.completed_lessons) {
                updateSidebarWithProgress(data.completed_lessons);
            }
        }
    } catch (error) {
        console.error('Failed to load learning progress:', error);
    }
}

// æ›´æ–°ä¾§è¾¹æ ä¸­çš„å®ŒæˆçŠ¶æ€
function updateSidebarWithProgress(completedLessons) {
    const lessonItems = document.querySelectorAll('.lesson-item');

    lessonItems.forEach(item => {
        const href = item.getAttribute('href');
        if (href) {
            let lessonPath = href.replace('/course_lesson_preview/', '');
            // æ ‡å‡†åŒ–ï¼šç§»é™¤ org_courses/ å‰ç¼€
            lessonPath = lessonPath.startsWith('org_courses/') ? lessonPath.replace('org_courses/', '') : lessonPath;

            if (completedLessons.includes(lessonPath)) {
                item.classList.add('completed');
            }
        }
    });
}
</script>
{% endblock %}
